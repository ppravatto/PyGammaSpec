---
jupytext:
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

(Guide-Calibration)=
# Using the `Calibration` class
The pulse height histogram generated by a Multi Channel Analyzer (MCA) is related to the gamma photon energy by some proportionality relation. To interpret the gamma energy spectrum the spectrum must be calibrated using some reference isotope with well defined gamma energies.

The `Calibration` class provides a simple tool to define the proportionality relation between channels and energy values. The class performs a polynomial fitting with a oder set by the user. The class uses the [`numpy.polyfit`](https://numpy.org/doc/stable/reference/generated/numpy.polyfit.html) funcion to perform the operation.

An instance of the calibration class can be constructed by providing a dictionary listing the values of the channel index together with the corresponding enerrgy (in $\text{keV}$). Once constructed the `Calibration` object can be used to calibrate a `GammaSpectrum` or to set the energy scale of a plot.

To show how the procedure works let us first load the background and sample spectra previously used in the [`GammaSpectrum` class tutorial](Guide-Spectrum).

```{code-cell} python
from pygammaspec.spectrum import GammaSpectrum
from pygammaspec.visualization import plot_spectrum

background = GammaSpectrum.from_PRA_histogram("../utils/background.txt", 25851)
sample = GammaSpectrum.from_PRA_histogram("../utils/weak_radium.txt", 25851)

plot_spectrum(sample, background, chrange=(0, 30))
```

The sample spectrum, even if very weak, shows the characteristic peaks of $^{226}\text{Ra}$ and its daughters ($^{214}\text{Pb}$, $^{214}\text{Bi}$). Let us use these peaks as calibration. To do so let us define a dictionary correlating the channel index with the energy of the corresponding photo-peak and then let us create a calibration object by using a second order polynomial:

```{code-cell} python
from pygammaspec.spectrum import Calibration

data = {
    14.41: 609.312,  # Bi-214
    9.12:  351.932,  # Pb-214
    7.86:  295.224,  # Pb-214
    6.59:  241.997,  # Pb-214
    5.21:  186.211,  # Ra-226
}

calibration = Calibration(data, 2)
```

The calibration curve can be visualized using the `plot_calibration` function from the `pygammaspec.visualization` module:

```{code-cell} python
from pygammaspec.visualization import plot_calibration

plot_calibration(calibration)
```

Once the calibration object has been created it can be applied to a `GammaSpectrum` object by using the built-in `calibration` property setter. Once the calibration has been applied the energy scale of the spectrum can be accessed directly, as a `list` of `float` values, using the property `energy`.

```{code-cell} python
background.calibration = calibration
sample.calibration = calibration

print("Sample energy scale (in keV):")
print(sample.energy)
```

The obtained calibation object can also be used to scale the spectrum plots providing the object to the `plot_spectrum` function:

```{code-cell} python
plot_spectrum(sample, background, chrange=(0, 30), external_calibration=calibration)
```

```{tip}
If the same valid calibration object is applied to both the `sample` and `background` spectra given to `plot_spectrum`, the funtion will automatically switch the x-axis to the energy scale. If a different calibration object is given as `external_calibration` this will override the previously given calibrations. As such, in the previous example the same result would have been obtained without specifying the `external_calibration` argument.
```
